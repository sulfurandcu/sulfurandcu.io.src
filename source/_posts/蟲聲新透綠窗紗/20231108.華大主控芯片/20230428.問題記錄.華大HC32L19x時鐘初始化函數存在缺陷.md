---
title: 問題記錄：華大 HC32L19x 時鐘初始化函數存在缺陷
id: cloqzg643003vmgrq0vxo85xp
date: 2023-04-28
tags: [華大半導體, HC32L19X]
categories: [問題記錄]
---

hc32l19x_reference_manaul

![](clock-tree.png)

<!-- more -->

hc32l19x_ddl_rev1.0.3

```c sysctrl.c
en_result_t Sysctrl_SysClkSwitch(en_sysctrl_clk_source_t enSource)
{
    en_result_t enRet = Ok;

    en_sysctrl_clk_source_t ClkNew = enSource;

    _SysctrlUnlock();
    M0P_SYSCTRL->SYSCTRL0_f.CLKSW = ClkNew;

    //更新Core時鐘（HCLK）
    SystemCoreClockUpdate();

    return enRet;
}

en_result_t Sysctrl_ClkInit(stc_sysctrl_clk_cfg_t *pstcCfg)
{
    en_result_t enRet = Ok;

    //系統時鐘參數配置
    switch(pstcCfg->enClkSrc)
    {
        case SysctrlClkRCH:

            break;
        case SysctrlClkXTH:
            Sysctrl_XTHDriverCfg(SysctrlXtalDriver3);
            Sysctrl_SetXTHStableTime(SysctrlXthStableCycle16384);
            break;
        case SysctrlClkRCL:
            Sysctrl_SetRCLStableTime(SysctrlRclStableCycle256);
            break;
        case SysctrlClkXTL:
            Sysctrl_XTLDriverCfg(SysctrlXtlAmp3, SysctrlXtalDriver3);
            Sysctrl_SetXTLStableTime(SysctrlXtlStableCycle16384);
            break;
        case SysctrlClkPLL:
            Sysctrl_SetPLLStableTime(SysctrlPllStableCycle16384);
            break;
        default:
            enRet = ErrorInvalidParameter;
            break;
    }

    //時鐘源使能
    Sysctrl_ClkSourceEnable(pstcCfg->enClkSrc, TRUE);

    //時鐘源切換
    Sysctrl_SysClkSwitch(pstcCfg->enClkSrc);

    //時鐘分頻設置
    Sysctrl_SetHCLKDiv(pstcCfg->enHClkDiv);
    Sysctrl_SetPCLKDiv(pstcCfg->enPClkDiv);

    return enRet;
}
```

Sysctrl_SysClkSwitch() 調用了 SystemCoreClockUpdate() 來更新 SystemCoreClock。這沒問題，問題是在這之後又去設置了 HCLK 的值，這就會導致 SystemCoreClock 與實際的 HCLK 不一致。

通過修改驅動庫，將「時鐘源切換」和「時鐘分頻設置」的執行順序對調即可解決該問題，若不想直接修改驅動庫，可以在調用 Sysctrl_ClkInit() 之後再調用一遍 SystemCoreClockUpdate()。
