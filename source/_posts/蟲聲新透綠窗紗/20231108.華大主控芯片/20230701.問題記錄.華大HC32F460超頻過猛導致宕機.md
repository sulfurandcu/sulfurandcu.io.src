---
title: 問題記錄：華大 HC32F460 超頻過猛導致 MCU 宕機
id: cloqxdq0v001nmgrq2um386nw
date: 2023-07-01
tags: [華大半導體, HC32F460]
categories: [問題記錄]
---

最近又把 MCU 給幹廢了，現象如下：

```
Load "main.axf"
* JLink Info: Device "CORTEX-M4" selected.
Set JLink Project File to "JLinkSettings.ini"
* JLink Info: Device "CORTEX-M4" selected.

JLink info:
------------
DLL: V7.22b, compiled Jun 17 2021 17:22:49
Firmware: J-Link V9 compiled May  7 2021 16:26:12
Hardware: V9.60
S/N : 69667602
Feature(s) : RDI, GDB, FlashDL, FlashBP, JFlash

* JLink Info: Found SW-DP with ID 0x2BA01477
* JLink Info: DPIDR: 0x2BA01477
* JLink Info: Scanning AP map to find all available APs
* JLink Info: AP[1]: Stopped AP scan as end of AP map has been reached
* JLink Info: AP[0]: AHB-AP (IDR: 0x24770011)
* JLink Info: Iterating through AP map to find AHB-AP to use
* JLink Info: AP[0]: Skipped. Invalid implementer code read from CPUIDVal[31:24] = 0x00
* JLink Info: Found SW-DP with ID 0x2BA01477
* JLink Info: DPIDR: 0x2BA01477
* JLink Info: Scanning AP map to find all available APs
* JLink Info: AP[1]: Stopped AP scan as end of AP map has been reached
* JLink Info: AP[0]: AHB-AP (IDR: 0x24770011)
* JLink Info: Iterating through AP map to find AHB-AP to use
* JLink Info: AP[0]: Skipped. Invalid implementer code read from CPUIDVal[31:24] = 0x00

***JLink Error: Could not find core in Coresight setup

Error: Flash Download failed  -  Target DLL has been cancelled
Flash Load finished at 10:35:22
```

事情經過是這樣的，某款產品第一版硬件的時鐘源選用的是 6MHz 的外部晶振，內部倍頻至 128MHz 作爲系統主頻，而第二版則改成了 24MHz 的外部晶振，第二版硬件出來後，將第一版程序直接燒錄進第二版硬件後 MCU 無法正常啓動且無法被識別。

初步推測，應該是外部晶振頻率提高，但是程序沒有進行適當地分頻，導致系統主頻遠遠超過數據手冊中規定的頻率上限（200MHz）。

<!--
公式使用工具 https://latexlive.com/ 生成
\begin{align}
& 128MHz × (24MHz / 6MHz) = 512MHz \ \ \ > \ \ \ MAX(200MHz) \\
\end{align}
-->
</p>
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtable displaystyle="true" columnalign="right left right left right left right left right left right left" columnspacing="0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em" rowspacing="3pt"><mtr><mtd></mtd><mtd><mn>128</mn><mi>M</mi><mi>H</mi><mi>z</mi><mo>×</mo><mo stretchy="false">(</mo><mn>24</mn><mi>M</mi><mi>H</mi><mi>z</mi><mrow><mo>/</mo></mrow><mn>6</mn><mi>M</mi><mi>H</mi><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mn>512</mn><mi>M</mi><mi>H</mi><mi>z</mi><mtext>&nbsp;</mtext><mtext>&nbsp;</mtext><mtext>&nbsp;</mtext><mo>&gt;</mo><mtext>&nbsp;</mtext><mtext>&nbsp;</mtext><mtext>&nbsp;</mtext><mi>M</mi><mi>A</mi><mi>X</mi><mo stretchy="false">(</mo><mn>200</mn><mi>M</mi><mi>H</mi><mi>z</mi><mo stretchy="false">)</mo></mtd></mtr></mtable></math>
<br>

後面通過調試，證實程序的確是在 `M4_SYSREG->CMU_CKSWR_f.CKSW = enTargetSysSrc;` 處出現異常。

上述操作其實就是「超頻」，只是超得有點猛，導致芯片直接宕機。這種情況藉助華大的離線下載器重新燒錄程序即可恢復正常。
