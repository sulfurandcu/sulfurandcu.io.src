---
title: 問題記錄：華大 HC32F460 內存邊界禁止非對齊訪問
id: cloqi184y000s8wrqg4ga0ei1
date: 2023-11-09 09:14:29
tags: [華大半導體, HC32F460]
categories: [問題記錄]
---

## 文章更新（2023-11-14）

經過排查，本文所述異常現象並非由「非對齊訪問」所致，而是因爲 SRAM3 開啓 ECC 校驗時僅支持以字爲單位進行訪問。

## 現象描述

- 程序無法正常啓動
- 有時會進入 hard fault 中斷
- 有時候會出現以下異常：

```
Call Stack + Locals                                                                    ✘
    Name                                Location/Value                          Type
    __scatterload_zeroinit              0x00074C56                              function
    __scatterload                       0x00018DFE                              function
```

<!-- more -->

## 基礎信息

### 芯片資源

- RAM 192KB/0x30000
- ROM 512KB/0x80000（其中通過分散加載給應用程序分配的空間爲 416KB/0x68000）

### 鏈接數據

```
==============================================================================

    Total RO  Size (Code + RO Data)               419844 ( 410.00kB)
    Total RW  Size (RW Data + ZI Data)            163952 ( 160.11kB)
    Total ROM Size (Code + RO Data + RW Data)     421056 ( 411.19kB)

==============================================================================
```

### 分散加載

```
LR_IROM1 0x00018000 0x00068000 {

	; 中斷向量
	ER_IROM1 0x00018000 0x00068000 {
		*.o (RESET, +First)
	}

	; 程序信息
	ER_IROM2 + 0 {
		*.o (SECTION_INFO_APP, +First)
	}

	; 程序代碼
	ER_IROM3 + 0 {
		*(InRoot$$Sections)
		.ANY (+RO)
	}

	; 內存空間
	RW_IRAM1 0x1FFF8000 0x00030000 {
		.ANY (+RW +ZI)
	}

}
```

## 原因分析

由於代碼量比較臨界，起初我以爲是 flash 的問題。但是 map 文件中顯示 ROM 只佔用了 411.19kB 的空間，並沒有超過 416KB 的總量。那 RAM 呢？RAM 只用了 160.11KB 也沒有超過 192KB 的總量，邪了門兒了真是！哎，等等！這款芯片的 RAM 我記得好像是分成了兩塊，怎麼說的來着，瞅一眼《參考手冊》：

![](HC32F460_manual.png)

果然，兩塊 RAM 間不支持非對齊訪問，再一看 SRAMH 的大小：32KB！~~破案了！現在 RAM 的用量不正好到達 160KB（192KB - 32KB = 160KB）這個臨界點了麼！~~

> 超過 160KB 確實會出現異常，但不是因達到 SRAMH 所致（SRAMH 地址最小，始終會用到）而是因達到 SRAM3 且使能 ECC 校驗所致。注意看紅線上面的那句話：「在允許 RAM ECC 校驗錯誤產生 NMI 中斷和復位的情況下，必須對所用 RAM 空間以字（16bit）爲單位進行訪問」。

按照現有分散加載文件的寫法，兩塊內存會被認爲是一個整體，那麼就必然存在「在內存邊界處進行非對齊訪問」的可能。

## 規避方法

非對齊訪問的風險可以在分散加載文件中將兩塊內存断开：

```
LR_IROM1 0x00018000 0x00068000 {

	; 中斷向量
	ER_IROM1 0x00018000 0x00068000 {
		*.o (RESET, +First)
	}

	; 程序信息
	ER_IROM2 + 0 {
		*.o (SECTION_INFO_APP, +First)
	}

	; 程序代碼
	ER_IROM3 + 0 {
		*(InRoot$$Sections)
		.ANY (+RO)
	}

	; 內存空間
	RW_IRAM1 0x1FFF8000 0x00007FF0 { ; 空出若干字節不用，以避免非對齊訪問。
		.ANY (+RW +ZI)
	}

	; 內存空間
	RW_IRAM2 0x20000000 0x00028000 {
		.ANY (+RW +ZI)
	}

}
```

SRAM3 開啓 ECC 後僅支持以字爲單位進行訪問的問題可以通過禁用 ECC 功能來解決。當然如果你一定要用 ECC 的話，那這塊空間肯定不能用來讓編譯器自動分配內存，而是要自己來手動管理。
