---
title: 問題記錄：華大 HC32F460 切換運行模式導致宕機
id: cloqsamms004qg4rq5jubc4h4
date: 2023-07-27
tags: [華大半導體, HC32F460]
categories: [問題記錄]
---

## 現象描述

- 從高速/超高速模式向超低速模式切換時 mcu 異常死機

## 基礎信息

- 當前使用華大 2.2.0 版驅動程序
- 當前使用華大 1.2.1 版參考手冊

## 原因分析

通過調試發現每次運行至 `M4_SYSREG->PWR_PWRC2` 賦值時程序就會跑飛😶

![電源模式控制寄存器 2](HC32F460-RM-Rev1.2-Register.png)

```c hc32f460_pwc.c
en_result_t PWC_HS2LS(void)
{
    ...

    M4_SYSREG->PWR_PWRC2 = 0xE1U;
    M4_SYSREG->PWR_MDSWCR = 0x10U;

    ...
}

en_result_t PWC_HP2LS(void)
{
    ...

    M4_SYSREG->PWR_PWRC2 = 0xD1U;
    M4_SYSREG->PWR_MDSWCR = 0x10U;

    ...
}
```

瞅了一眼《參考手冊 Rev1.2.1》好像也沒啥問題，又看了《參考手冊 Rev1.3》後，我得發...🙄！

兩版手冊竟然不一樣！

<!-- more -->

### Rev1.2.1

![運行模式的切換流程（Rev1.2）](HC32F460-RM-Rev1.2.png)

### Rev1.3.0

![運行模式的切換流程（Rev1.3）](HC32F460-RM-Rev1.3.png)

這妥妥的是華大的鍋了...
