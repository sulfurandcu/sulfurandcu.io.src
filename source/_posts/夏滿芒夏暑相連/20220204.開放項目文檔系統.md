---
title: 開放項目文檔系統
id: open-doc
date: 2022-02-04 00:00:00
updated:
tags:
categories: [個人博客]
---

---

![](cover.png)

---

<!--more-->

本系统运行于某台计算机中。

该计算机上有一个文件夹，文件夹中放着本系统的配置文件和各项目的文档文件。这些内容被一个叫做文档网站生成器的软件动态转换成网页在 3000 端口以 HTTP 的形式对外提供访问。

?> 文档网站生成器（[docsify](https://docsify.js.org/)）

该计算机上还运行着一个周期任务，该任务每隔 15 分钟（准确地说是在00分、15分、30分、45分的时候）**从 SVN 服务器中**更新一次上述文件夹。

?> `#web` http://127.0.0.1:3000

?> `#ssh` localhost@127.0.0.1 📢 Password:password

?> `#svn` http://svn.com/documents


## 使用说明

如果你想阅读本站的内容，那么只需要在局域网内访问 127.0.0.1:3000 即可浏览该文档。

如果你想协助构建本系统，以下内容应该会有所帮助。（😄）

### 准备工作

- 首先，本系统基于 docsify 构建，建议在开始之前先去了解一下该工具的使用，[官网](https://docsify.js.org/#/zh-cn/)上有着详细的说明。

- 其次，本文档中的文本使用 markdown 语法编写，不了解的小伙伴需要先去[这里](https://www.markdownguide.org/basic-syntax/)学习一下。

- 另外，本文档中的图例使用 draw.io 绘制并导出，该工具有[安装版](https://www.diagrams.net/)和[网页版](https://www.diagrams.net/)。（可选）

- 最后，本系统中的文件托管在 SVN 服务器上，编辑之前要先拉取一份至本地。

```
http://svn.com/documents
```

### 在当前框架下新增子项目

- 从上述 SVN 服务器中拷贝一份该文档系统的源码至本地

- 参照模板创建目录和文档

- 编辑文档

- 预览效果

- 提交变更

- 大功告成！等待几分钟后即可在浏览器中访问！

### 新建一个独立的文档系统

如果当前框架已经无法满足你的要求，可以另外新建一个文档系统。结构与本系统类似，只要注意端口不要冲突即可，其他不再做过多说明。


## 常见问题

### 服务器重启后远程无法连接的解决办法！

- 使用「远程桌面连接」连接服务器，进入 E 盘根目录双击运行 boot.bat 脚本。

### 服务器重启后网页无法访问的解决办法！

- 同上

### 修改提交之后没有周期更新的排查方法！

- 首先看周期任务是否正常执行

- 如果周期任务执行没有问题，那么有可能是管理员的帐号密码修改过，而本文档服务器中 svn 的访问密码没有同步修改导致的。

!> 系统会强制让职工每隔两个月修改一次密码


## 技术细节

首先需要说明的是，服务器中运行的系统为 Windows 操作系统，因此以下操作均基于该操作系统。

### 开机自动执行

服务器启动后应当自动开启 sshd 服务和 docsify 服务，这样我们就可以使用 ssh 来远程连接该服务器，使用浏览器访问该文档系统。

在 Windows 系统中，我们使用以下脚本实现：

```
# boot.bat

%1 mshta vbscript:CreateObject("Shell.Application").ShellExecute("cmd.exe","/c %~s0 ::","","runas",1)(window.close)&&exit
net start sshd
E:
cd open-doc
index.bat
```

测试发现，脚本在启动时有可能会执行失败，所以在周期任务中会执行另一个脚本再次开启 sshd 服务：

```
# sshd.bat

%1 mshta vbscript:CreateObject("Shell.Application").ShellExecute("cmd.exe","/c %~s0 ::","","runas",1)(window.close)&&exit
net start sshd
```

?> 脚本第一行的目的是创建具有管理员权限的交互窗口，因为 net start sshd 指令需要管理员权限。

### 周期更新文档

服务器运行中应当每隔一段时间从 SVN 更新一次文档。

在 Windows 系统中，我们使用系统自带的任务计划程序实现，在〈计算机管理・任务计划程序〉中创建一个周期任务，每隔一段时间执行一次以下这个脚本。

```
# doc.py

import os

cmd = "svn up \"e:/open-doc\" --non-interactive"
os.system(cmd)
```

?> 周期任务除了执行 doc.py 这个脚本之外，还会执行上述 sshd.bat 脚本。

### 手动更新文档

改动提交之后想立即更新至文档服务器应该怎么做呢？

远程连接到服务器，手动执行一下 E 盘根目录下的 doc.py 即可。

### 其他方式开启 docsify 服务

在 ssh 交互窗口中直接执行 `docsify serve` 可以开启 docsify 服务，但是在断开 ssh 连接时 docsify 服务也会随之停止。那可不可以让它在后台运行呢？答案是肯定的！

首先，在文档目录下创建一个脚本（目前这个脚本已经存在）：

```
# index.bat

docsify serve -p 3000
```

然后，在 powershell 中执行以下命令：

```
start-process -windowstyle hidden -filepath "index.bat"
```

这样，该服务就会在后台运行。

这时，可以执行以下命令来查询该进程的信息：

```
get-process -name "node"
```

```
Handles  NPM(K)    PM(K)      WS(K)     CPU(s)     Id  SI ProcessName
-------  ------    -----      -----     ------     --  -- -----------
    107      12    11700      18224       0.08   4708   0 node
```

另外，还有这么一种查询进程信息的操作：

```
$process = start-process -windowstyle hidden -filepath "index.bat" -PassThru
Write-Host "process id is $($process.Id)"
```

只是，这种方式查询到的 pid 是「命令处理程序」的而不是 Node.js JavaScript Runtime 进程的。


### 为什么选择 docsify 而不是其他的文档生成器？

之前用过 hexo 和 hugo 生成静态网页，但是他们均需要将 markdown 文件预先编译成 html 文件后才能访问，在不配置提交触发编译的情况下使用起来很不方便。而 docsify 是动态生成文档网站，不需要一些繁琐的操作，原始文档修改保存之后网页会立即更新，十分好用。


## 附加信息

### 文档中使用的字体是什么？

正文中拉丁字符使用内嵌的 EB Garamond 字体。代码中拉丁字符使用内嵌的 Iosevka Term Curly Slab 字体。正文中泛中日韩字符使用以下字体（按顺序）渲染：

```
Source Han Serif SC     思源宋体
Source Han Sans  SC     思源黑体

PingFang SC             苹果平方
Microsoft YaHei         微软雅黑

sans-serif              系统默认
```

鉴于泛中日韩字体文件通常较大，所以暂时未做内嵌处理。追求显示效果的同学可以自行前往下载并安装：

- [EB Garamond](https://fonts.google.com/specimen/EB+Garamond)
- [Iosevka](https://typeof.net/Iosevka)
- [Source Han Sans](https://github.com/adobe-fonts)
- [Source Han Serif](https://github.com/adobe-fonts)

?> 啰嗦一嘴，使用字体处理工具 fonttool 和字符匹配工具 ripgrep 将文章中使用到的字符提取出来重新打包，可以极大地压缩原始字体文件的大小。只是这样做有降低工作效率的可能性，所以不予采用。感兴趣的同学可以利用业余时间研究一下。

### 图片中使用的字体是什么？

这里的图片指的是由 draw.io 导出的图片。图片中使用的是「[更纱黑体](https://github.com/be5invis/Sarasa-Gothic)」中的 Sarasa Term SC 子集。

?> Sarasa Term SC = Source Han Sans SC + Iosevka Term


## 联系方式

[sulfurandcu@gmail.com](mailto:sulfurandcu@gmail.com)


## 版权信息

copyright © sulfurandcu
